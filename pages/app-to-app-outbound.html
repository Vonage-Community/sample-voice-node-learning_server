<!DOCTYPE html>
<html lang="en">

<head>
  <title>App to App outbound</title>
  <script src="https://cdn.jsdelivr.net/npm/@vonage/client-sdk@latest/dist/vonageClientSDK.min.js"></script>
  <style>
    input, button {
      font-size: 1rem;
    }
    #login-inbound, #call, #hangup {
      display: none;
    }
  </style>
</head>

<body>
    &lt; <a href="/">Home</a>
    <br /><br />
    <h1>Outbound App Call</h1>
    <div id="login-outbound">
        <p>1. Enter name of user making the call:</p>
        <label for="name-outbound">Name:</label>
        <input type="text" name="name-outbound" value="" placeholder="i.e. ALICE" id="name-outbound" size="30">
        <br /><br />
        <button type="button" id="login-button-outbound">Login</button>
    </div>
    <div id="login-inbound">
        <p>Logged in as: <span id="logged-in-user"></span></p>
        <p>2. Enter name of user receiving the call:</p>
        <label for="name-inbound">Name:</label>
        <input type="text" name="name-inbound" value="" placeholder="i.e. BOB" id="name-inbound" size="30">
        <br /><br />
        <small>*This will open a new tab and log in as this user.</small>
        <br />
        <button type="button" id="login-button-inbound">Login</button>
    </div>
    <div id="call-controls">
        <small>*Answer the call in the other tab.</small>
        <button type="button" id="call">Call <span id="call-to-name"></span></button>
        <button type="button" id="hangup">Hang Up</button>
    </div>

    <script>
        const callButton = document.getElementById("call");
        const hangUpButton = document.getElementById("hangup");
        let token;
        const client = new vonageClientSDK.VonageClient();
        let callId = null;
        let inboundUsername;
        let inboundDisplayName;
        let outboundDisplayName;

        client.on('legStatusUpdate', (callId, legId, status) => {
          if (status === "ANSWERED") {
              callButton.style.display = "none";
              hangUpButton.style.display = "inline";
          }
          if (status === "COMPLETED") {
              callButton.style.display = "inline";
              hangUpButton.style.display = "none";
          }
        });

        callButton.addEventListener("click", () => {
          client.serverCall({ to: inboundUsername })
            .then((_callId) => {
              callId = _callId;
            })
            .catch((error)=>{
              console.error(`Error making call: ${error}`);
            });
        });

        hangUpButton.addEventListener("click", () => {
          console.log("Hanging up...");
          client.hangup(callId)
            .then(() => {
              hangUpButton.style.display = "none";
              callButton.style.display = "inline";
            })
            .catch(error => {
              console.error("Error hanging up call: ", error);
            });                
        });

        document.getElementById("login-button-outbound").addEventListener("click", () => {
            const outboundDisplayName = document.getElementById("name-outbound").value;
            if (outboundDisplayName) {
                // Fetch the JWT token for the user from your server
                fetch(`/token?name=${outboundDisplayName}`)
                .then(response => response.json())
                .then(data => {
                    token = data.token;
                    console.log("Fetched token: ", token);
                    client.createSession(token)
                    .then(sessionId => {
                        console.log("Id of created session: ", sessionId);
                        document.getElementById("login-outbound").style.display = "none";
                        document.getElementById("login-inbound").style.display = "block";
                        document.querySelector("#logged-in-user").textContent = outboundDisplayName;
                    })
                    .catch(error  => { 
                        console.error("Error creating session: ", error);
                    });
                })
                .catch(error => {
                    console.error("Error fetching token: ", error);
                });
            } else {
                alert("Please enter a username.");
            }
        });
      
        document.getElementById("login-button-inbound").addEventListener("click", () => {
            inboundDisplayName = document.getElementById("name-inbound").value;
            if (inboundDisplayName) {
                inboundUsername = inboundDisplayName.toLowerCase().replaceAll(" ", "-");
                window.open(`/app-to-app-inbound.html?user=${inboundDisplayName}`, '_blank');
                document.getElementById("call-to-name").textContent = inboundDisplayName;
                document.getElementById("login-inbound").style.display = "none";
                callButton.style.display = "inline";
                document.getElementById("call-controls").style.display = "block";
            } else {
                alert("Please enter a username.");
            }
        });
    </script>
</body>
</html>
