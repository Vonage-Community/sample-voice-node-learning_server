<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cdn.jsdelivr.net/npm/@vonage/client-sdk@latest/dist/vonageClientSDK.min.js"></script>
  <style>
    input, button {
      font-size: 1rem;
    }
    #app {
      display: none;
    }
    #answer, #reject, #hangup {
      display: none;
    }
  </style>
</head>

<body>
    &lt; <a href="/">Home</a>
    <br /><br />
    <div id="login">
        <h1>Login</h1>
        <p>To receive a call from a PSTN phone, you need to login first.</p>
        <label for="name">Name:</label>
        <input type="text" name="name" value="" placeholder="i.e. ALICE" id="name" size="30">
        <br /><br />
        <button type="button" id="login-button">Login</button>
    </div>
    <div id="app">
        <h1>Inbound PSTN phone call</h1>
        <p id="notification">Lines are open for calls...</p>
        <br />
        <button type="button" id="answer">Answer</button>
        <button type="button" id="reject">Reject</button>
        <button type="button" id="hangup">Hang Up</button>
    </div>

  <script>
    const answerButton = document.getElementById("answer");
    const rejectButton = document.getElementById("reject");
    const hangUpButton = document.getElementById("hangup");
    const notification = document.getElementById("notification");
    let token;
    const client = new vonageClientSDK.VonageClient();
    let callId = null;

    client.on('callInvite', (_callId, from, channelType) => {
      callId = _callId;
      console.log(`Incoming call from ${from} via ${channelType}, callId: ${callId}`);
      notification.textContent = "You are receiving a call";
      answerButton.style.display = "inline";
      rejectButton.style.display = "inline";
    });

    client.on('legStatusUpdate', (_callId, legId, status) => {
      notification.textContent = `Caller Leg Status is: ${status}`;
    });

    client.on('callInviteCancel', (_callId) => {
      console.log(`Call invite has been cancelled, callId: ${_callId}`);
      callId = null;
      notification.textContent = "The caller has cancelled the call";
      answerButton.style.display = "none";
      rejectButton.style.display = "none";
      hangUpButton.style.display = "none";
      setTimeout(() => {
        notification.textContent = "Lines are open for calls...";
      }, 3000);
    });

    client.on("callHangup", (_callId, callQuality, reason) => {
      console.log(`Call ${_callId} has hung up, callQuality:${callQuality}, reason:${reason}`);
      callId = null;
      notification.textContent = "Lines are open for calls...";
      answerButton.style.display = "none";
      rejectButton.style.display = "none";
      hangUpButton.style.display = "none";
    });

    // Answer the call.
    answerButton.addEventListener("click", () => {
      client.answer(callId)
        .then(() => {
          console.log("Success answering call.");
          notification.textContent = "You are on a call";
          answerButton.style.display = "none";
          rejectButton.style.display = "none";
          hangUpButton.style.display = "inline";
        })
        .catch(error => {
          console.error("Error answering call: ", error);
        });    
    });

    // Reject the call
    rejectButton.addEventListener("click", () => {
      client.reject(callId)
        .then(() => {
          console.log("Success rejecting call.");
          notification.textContent = "You rejected the call";
          answerButton.style.display = "none";
          rejectButton.style.display = "none";
          setTimeout(() => {
            notification.textContent = "Lines are open for calls...";
          }, 3000);

        })
        .catch(error => {
          console.error("Error rejecting call: ", error);
        });          
    });

    // Hang up the call
    hangUpButton.addEventListener("click", () => {
      client.hangup(callId)
        .then(() => {
          console.log("Success hanging up call.");
          notification.textContent = "You ended the call";
          answerButton.style.display = "none";
          rejectButton.style.display = "none";
          hangUpButton.style.display = "none";
          setTimeout(() => {
            notification.textContent = "Lines are open for calls...";
          }, 3000);
        })
        .catch(error => {
          console.error("Error hanging up call: ", error);
        });                
    });

    document.getElementById("login-button").addEventListener("click", () => {
      const name = document.getElementById("name").value;
      if (name) {
        // Fetch the JWT token for the user from your server
        fetch(`/token?name=${name}`)
          .then(response => response.json())
          .then(data => {
            token = data.token;
            client.createSession(token)
              .then(sessionId => {
                document.getElementById("login").style.display = "none";
                document.getElementById("app").style.display = "block";
              })
              .catch(error  => { 
                console.error("Error creating session: ", error);
              });
          })
          .catch(error => {
            console.error("Error fetching token: ", error);
          });
      } else {
        alert("Please enter a username.");
      }
    });
  </script>
</body>

</html>
