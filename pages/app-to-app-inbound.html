<!DOCTYPE html>
<html lang="en">

<head>
  <title>App to App inbound</title>
  <script src="https://cdn.jsdelivr.net/npm/@vonage/client-sdk@latest/dist/vonageClientSDK.min.js"></script>
  <style>
    input, button {
      font-size: 1rem;
    }
    #answer {
      display: none;
    }
  </style>
</head>

<body>
  <h1>Inbound App Call (<span id="user-name"></span>)</h1>
  <p id="notification">logging in...</p>
  <br />
  <button id="answer">Answer</button>

  <script>
    // Get user from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const user = urlParams.get('user') || 'Bob';
    const answerButton = document.getElementById("answer");
    const notification = document.getElementById("notification");
    let token;
    const client = new vonageClientSDK.VonageClient();
    let callId = null;

    client.createSession(token)
      .then((sessionId) => {
        console.log(sessionId);
      })
      .catch((error) => {
        console.error(error);
      });

    client.on('callInvite', (_callId) => {
      callId = _callId;
      notification.textContent = "You are receiving a call";
      answerButton.style.display = "inline";
    });

    client.on('callHangup', (callId, callQuality, reason) => {
      callId = null;
      notification.textContent = "Lines are open for calls...";
      answerButton.style.display = "none";
    });

    // Answer the call.
    answerButton.addEventListener("click", () => {
      client.answer(callId)
        .then(() => {
          console.log("Success answering call.");
          notification.textContent = "You are on a call";
          answerButton.style.display = "none";
        })
        .catch(error => {
          console.error("Error answering call: ", error);
        });    
    });
    
    window.onload = () => {
        if (user) {
            // Fetch the JWT token for the user from your server
            fetch(`/token?name=${user}`)
            .then(response => response.json())
            .then(data => {
                token = data.token;
                console.log("Fetched token: ", token);
                client.createSession(token)
                .then(sessionId => {
                    document.getElementById("user-name").textContent = user;
                    console.log("Id of created session: ", sessionId);
                    notification.textContent = "Lines are open for calls...";
                })
                .catch(error  => { 
                    console.error("Error creating session: ", error);
                });
            })
            .catch(error => {
                console.error("Error fetching token: ", error);
            });
        } else {
            alert("Please enter a username.");
        }
    };
  </script>
</body>

</html>
